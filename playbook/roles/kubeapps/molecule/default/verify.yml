---
- name: Verify
  hosts: all
  gather_facts: false
  tasks:
    - name: Get single node
      command: kubectl get nodes
      changed_when: false
      register: kubernetes_nodes

    - name: Print list of running nodes.
      debug: var=kubernetes_nodes.stdout

    - name: Assert master node ready
      ansible.builtin.assert:
        that: '"node-0   Ready    control-plane,master" in kubernetes_nodes.stdout'

    - name: Get Kubeapps service infos
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Service
        name: kubeapps
        kubeconfig: /etc/rancher/k3s/k3s.yaml
        wait: yes
        namespace: "kubeapps"
      register: kubeapps_infos

    # - name: Print list of running nodes.
    #   debug: var=kubeapps_infos.resources

    - name: Assertions on service kubeapps 
      assert:
        that:
          - kubeapps_infos.resources | length > 0
          - kubeapps_infos.resources[0].spec.type == "ClusterIP"
