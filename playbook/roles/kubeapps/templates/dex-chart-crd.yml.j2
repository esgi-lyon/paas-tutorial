apiVersion: v1
kind: Namespace
metadata:
  name: {{ kubeapps_dex_namespace }}
---
apiVersion: v1
kind: Secret
metadata:
  name: github-client
  namespace: {{ kubeapps_dex_namespace }}
type: Opaque
data:
  client-id: {{ kubeapps_dex_github_client_id }}
  client-secret: {{ kubeapps_dex_github_client_secret }}
---
apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: dex
  namespace: kube-system
spec:
  chart: dex
  targetNamespace: {{ kubeapps_dex_namespace }}
  repo: https://charts.dexidp.io
  valuesContent: |-
    envVars:
      - name: GITHUB_CLIENT_ID
        valueFrom:
          secretKeyRef:
            name: github-client
            key: client-id
      - name: GITHUB_CLIENT_SECRET
        valueFrom:
          secretKeyRef:
            name: github-client
            key: client-secret
    service:
      ports:
        http:
          nodePort: 5556
    ingress:
      enabled: true
      annotations:
        #cert-manager.io/issuer-kind: ClusterIssuer
        #cert-manager.io/cluster-issuer: letsencrypt-acme-issuer
        #cert-manager.io/issuer-group: cert-manager.io
        #cert-manager.io/certificate-name: "{{ kubeapps_dex_hostname }}-tls"
        #certmanager.k8s.io/acme-challenge-type: "http01"
        kubernetes.io/ingress.class: "{{ kubeapps_k8s_ingress_class }}"
        traefik.frontend.passHostHeader: "true"
        traefik.backend.loadbalancer.sticky: "true"
      hosts:
      - host: {{ kubeapps_dex_hostname }}
        paths:
          - path: /
            pathType: ImplementationSpecific
    config:
      issuer: {{ kubeapps_dex_issuer }}
      storage:
        type: kubernetes
        config:
          inCluster: true
      web:
        http: 0.0.0.0:5556
      connectors:
      - type: github
        id: github
        name: GitHub
        config:
          clientID: $GITHUB_CLIENT_ID
          clientSecret: $GITHUB_CLIENT_SECRET
          redirectURI: https://{{ kubeapps_dex_issuer }}/callback
          org: {{ kubeapps_dex_github_client_org }}
      oauth2:
        skipApprovalScreen: true
      staticClients:
      - id: example-app
        redirectURIs:
        - 'http://0.0.0.0/callback'
        name: 'Example App'
        secret: ZXhhbXBsZS1hcHAtc2VjcmV0
      enablePasswordDB: true
