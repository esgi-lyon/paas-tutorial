apiVersion: v1
kind: Namespace
metadata:
  name: {{ cert_manager_namespace }}

---
apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: cert-manager
  namespace: kube-system
spec:
  chart: cert-manager
  targetNamespace: {{ cert_manager_namespace }}
  repo: https://charts.jetstack.io
  valuesContent: |-
    installCRDs: true
---

{% if cert_manager_cluster_issuer == 'letsencrypt-local' -%}
apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: pebble
  namespace: kube-system
spec:
  chart: pebble
  targetNamespace: {{ cert_manager_namespace }}
  repo: https://jupyterhub.github.io/helm-chart
---
{% endif -%}

apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-acme-issuer
spec:
  acme:
    skipTLSVerify: {{ cert_manager_skipTLSVerify }}
    email: {{ cert_manager_email }}
    server: {{ cert_manager_servers[cert_manager_cluster_issuer] }}
    privateKeySecretRef:
      name: acme-account-key
    solvers:
    - http01:
        ingress:
          class: {{ kubeapps_k8s_ingress_class }}
