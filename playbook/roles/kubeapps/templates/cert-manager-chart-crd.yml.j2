apiVersion: v1
kind: Namespace
metadata:
  name: {{ cert_manager_namespace }}

---
apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: cert-manager
  namespace: kube-system
spec:
  chart: cert-manager
  targetNamespace: {{ cert_manager_namespace }}
  repo: https://charts.jetstack.io
  valuesContent: |-
    installCRDs: true
---
apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: cert-manager-trust
  namespace: kube-system
spec:
  version: 0.2.0
  chart: cert-manager-trust
  targetNamespace: {{ cert_manager_namespace }}
  repo: https://charts.jetstack.io
---
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-acme-issuer
spec:
  acme:
    skipTLSVerify: {{ cert_manager_is_local }}
    email: {{ cert_manager_email }}
    server: {{ cert_manager_servers[cert_manager_cluster_issuer] }}
    privateKeySecretRef:
      name: acme-account-key
    solvers:
    - selector: {}
      http01:
        ingress:
          class: {{ kubeapps_k8s_ingress_class }}
---
{% if cert_manager_is_local %}
apiVersion: trust.cert-manager.io/v1alpha1
kind: Bundle
metadata:
  name: pebble-ca-share
spec:
  sources:
  - configMap:
      name: "pebble-root-ca"
      key: "ca.crt"

  target:
    configMap:
      key: "ca.crt"
{% endif %}
