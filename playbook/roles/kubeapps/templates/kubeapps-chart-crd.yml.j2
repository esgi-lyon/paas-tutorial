apiVersion: v1
kind: Namespace
metadata:
  name: {{ kubeapps_namespace }}
---

apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: kubeapps
  namespace: kube-system
spec:
  chart: kubeapps
  version: 12.1.1
  targetNamespace: {{ kubeapps_namespace }}
  repo: https://charts.bitnami.com/bitnami
  valuesContent: |-
    ingress:
      tls: true
      enabled: true
      hostname: "{{ kubeapps_hostname }}"
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt-acme-issuer
        kubernetes.io/ingress.class: "{{ kubeapps_k8s_ingress_class }}"
        traefik.frontend.passHostHeader: "true"
        traefik.ingress.kubernetes.io/router.tls: "true"
        ingress.kubernetes.io/auth-trust-headers: "true"
        ingress.kubernetes.io/auth-response-headers: "X-Auth-Request-User, X-Auth-Request-Groups, X-Auth-Request-Email, Authorization, Set-Cookie"

    authProxy:
      enabled: true
      provider: oidc
      clientID: "{{ kubeapps_dex_client_id }}"
      clientSecret: "{{ kubeapps_dex_client_secret }}"
      cookieSecret: '{{ kubeapps_oauth_proxy_cookie_secret }}'
      cookieRefresh: 5m
      extraFlags:
        - --oidc-issuer-url=https://{{ kubeapps_dex_hostname }}
        - --set-authorization-header=true
        - --set-xauthrequest=true
        - --pass-access-token=true 
        - --skip-auth-preflight
      extraVolumeMounts:
        {{ dex_ca_extra_volumes_mounts | to_nice_yaml | indent(8) }}

    frontend:
      # proxypassAccessTokenAsBearer: true
      extraVolumes:
        {{ dex_ca_extra_volumes | to_nice_yaml | indent(8) }}

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: kubeapps-github-teams
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
  - kind: Group
    name: "{{ kubeapps_dex_github_client_org }}:{{ kubeapps_dex_github_client_team }}"
